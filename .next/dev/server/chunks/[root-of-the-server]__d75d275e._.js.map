{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/services/healthService.ts"],"sourcesContent":["import { promises as fs } from \"fs\";\nimport path from \"path\";\nimport type {\n  PetHealth,\n  HealthRecord,\n  MedicalAppointment,\n  Vaccination,\n  VitalStats,\n} from \"../types/health\";\n\nconst DB_PATH = path.join(process.cwd(), \"data\", \"health.json\");\n\nclass HTTPError extends Error {\n  status: number;\n  constructor(message: string, status = 500) {\n    super(message);\n    this.status = status;\n    this.name = \"HTTPError\";\n  }\n}\n\nasync function ensureDB() {\n  try {\n    await fs.access(DB_PATH);\n  } catch (e) {\n    const init = { pets: [] };\n    await fs.mkdir(path.dirname(DB_PATH), { recursive: true });\n    await fs.writeFile(DB_PATH, JSON.stringify(init, null, 2), \"utf8\");\n  }\n}\n\nasync function readDB(): Promise<{ pets: PetHealth[] }> {\n  await ensureDB();\n  const raw = await fs.readFile(DB_PATH, \"utf8\");\n  try {\n    const parsed = JSON.parse(raw);\n    parsed.pets = parsed.pets || [];\n    return parsed;\n  } catch (e) {\n    // If DB is corrupted, reinitialize\n    const init = { pets: [] };\n    await writeDB(init);\n    return init;\n  }\n}\n\nasync function writeDB(db: any) {\n  await fs.writeFile(DB_PATH, JSON.stringify(db, null, 2), \"utf8\");\n}\n\nfunction makeId() {\n  return (global as any).crypto?.randomUUID?.() ?? Date.now().toString();\n}\n\nfunction requirePetId(petId?: string) {\n  if (!petId) throw new HTTPError(\"Missing petId\", 400);\n}\n\nfunction sanitizeString(input?: any) {\n  if (input === undefined || input === null) return \"\";\n  return String(input).trim();\n}\n\nexport async function listPets(): Promise<\n  Array<{ petId: string; name?: string; species?: string }>\n> {\n  const db = await readDB();\n  return (db.pets || []).map((p: any) => ({\n    petId: p.petId,\n    name: p.name,\n    species: p.species,\n  }));\n}\n\n/**\n * Keep createPet for compatibility but note that pet creation should be centralized.\n */\nexport async function createPet(\n  name: string,\n  species?: string,\n  customPetId?: string\n): Promise<PetHealth> {\n  const n = sanitizeString(name);\n  if (!n) throw new HTTPError(\"Missing name\", 400);\n  const db = await readDB();\n  const petId = customPetId || makeId();\n  const newPet: PetHealth = {\n    petId,\n    name: n,\n    species: sanitizeString(species) || \"unknown\",\n    vitalStats: {},\n    vaccinations: [],\n    appointments: [],\n    healthRecords: [],\n  };\n  db.pets = db.pets || [];\n  db.pets.push(newPet);\n  await writeDB(db);\n  return newPet;\n}\n\nexport async function getPetById(petId?: string): Promise<PetHealth> {\n  requirePetId(petId);\n  const db = await readDB();\n  const pet = (db.pets || []).find((p: any) => p.petId === petId);\n  if (!pet) throw new HTTPError(\"Pet not found\", 404);\n  return pet as PetHealth;\n}\n\nexport async function addRecord(\n  petId: string,\n  payload: Partial<HealthRecord>\n): Promise<HealthRecord> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const record: HealthRecord = {\n    id: makeId(),\n    date:\n      sanitizeString(payload.date) || new Date().toISOString().split(\"T\")[0],\n    type: sanitizeString(payload.type) || \"note\",\n    practitioner: sanitizeString(payload.practitioner),\n    notes: sanitizeString(payload.notes),\n  };\n  db.pets[idx].healthRecords = db.pets[idx].healthRecords || [];\n  db.pets[idx].healthRecords.unshift(record);\n  await writeDB(db);\n  return record;\n}\n\nexport async function addAppointment(\n  petId: string,\n  payload: Partial<MedicalAppointment>\n): Promise<MedicalAppointment> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const appointment: MedicalAppointment = {\n    id: makeId(),\n    date: sanitizeString(payload.date),\n    time: sanitizeString(payload.time),\n    type: sanitizeString(payload.type) || \"consultation\",\n    practitioner: sanitizeString(payload.practitioner),\n    notes: sanitizeString(payload.notes),\n  };\n  db.pets[idx].appointments = db.pets[idx].appointments || [];\n  db.pets[idx].appointments.unshift(appointment);\n  await writeDB(db);\n  return appointment;\n}\n\nexport async function addVaccination(\n  petId: string,\n  payload: Partial<Vaccination>\n): Promise<Vaccination> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const vaccination: Vaccination = {\n    id: makeId(),\n    name: sanitizeString(payload.name),\n    date: sanitizeString(payload.date),\n    nextDueDate: sanitizeString(payload.nextDueDate) || undefined,\n    status: (payload?.status as any) || \"up-to-date\",\n  };\n  db.pets[idx].vaccinations = db.pets[idx].vaccinations || [];\n  db.pets[idx].vaccinations.unshift(vaccination);\n  await writeDB(db);\n  return vaccination;\n}\n\nexport async function deleteRecord(\n  petId: string,\n  recordId: string\n): Promise<HealthRecord> {\n  requirePetId(petId);\n  if (!recordId) throw new HTTPError(\"Missing recordId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].healthRecords = db.pets[idx].healthRecords || [];\n  const recIdx = db.pets[idx].healthRecords.findIndex(\n    (r: any) => r.id === recordId\n  );\n  if (recIdx === -1) throw new HTTPError(\"Record not found\", 404);\n  const [deleted] = db.pets[idx].healthRecords.splice(recIdx, 1);\n  await writeDB(db);\n  return deleted as HealthRecord;\n}\n\nexport async function deleteAppointment(\n  petId: string,\n  appointmentId: string\n): Promise<MedicalAppointment> {\n  requirePetId(petId);\n  if (!appointmentId) throw new HTTPError(\"Missing appointmentId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].appointments = db.pets[idx].appointments || [];\n  const aIdx = db.pets[idx].appointments.findIndex(\n    (a: any) => a.id === appointmentId\n  );\n  if (aIdx === -1) throw new HTTPError(\"Appointment not found\", 404);\n  const [deleted] = db.pets[idx].appointments.splice(aIdx, 1);\n  await writeDB(db);\n  return deleted as MedicalAppointment;\n}\n\nexport async function deleteVaccination(\n  petId: string,\n  vaccinationId: string\n): Promise<Vaccination> {\n  requirePetId(petId);\n  if (!vaccinationId) throw new HTTPError(\"Missing vaccinationId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].vaccinations = db.pets[idx].vaccinations || [];\n  const vIdx = db.pets[idx].vaccinations.findIndex(\n    (v: any) => v.id === vaccinationId\n  );\n  if (vIdx === -1) throw new HTTPError(\"Vaccination not found\", 404);\n  const [deleted] = db.pets[idx].vaccinations.splice(vIdx, 1);\n  await writeDB(db);\n  return deleted as Vaccination;\n}\n\nexport async function updateVital(\n  petId: string,\n  payload: Partial<VitalStats>\n): Promise<VitalStats> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const existing = db.pets[idx].vitalStats || {};\n  const updated: VitalStats = Object.assign({}, existing, payload || {});\n  db.pets[idx].vitalStats = updated;\n  await writeDB(db);\n  return updated;\n}\n\nexport { HTTPError };\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 278, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/app/api/health/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { listPets, getPetById } from \"../../../services/healthService\";\nimport type { Vaccination, MedicalAppointment } from \"../../../types/health\";\n\ninterface UrgentReminder {\n  id: string;\n  type: \"vaccination\" | \"appointment\";\n  title: string;\n  petName: string;\n  date: string;\n  daysUntil: number;\n  urgencyLevel: \"critical\" | \"warning\" | \"info\";\n}\n\n// Health route - GET pour récupérer les rappels urgents\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const action = searchParams.get(\"action\");\n\n    if (action === \"urgent-reminders\") {\n      return await getUrgentReminders();\n    }\n\n    return NextResponse.json({ status: \"ok\" });\n  } catch (error) {\n    console.error(\"Erreur API health:\", error);\n    return NextResponse.json({ error: \"Erreur serveur\" }, { status: 500 });\n  }\n}\n\nasync function getUrgentReminders(): Promise<NextResponse> {\n  try {\n    const pets = await listPets();\n    const reminders: UrgentReminder[] = [];\n\n    // Parcourir tous les animaux\n    for (const pet of pets) {\n      try {\n        const petHealth = await getPetById(pet.petId);\n\n        // Vérifier les vaccinations\n        if (petHealth.vaccinations && petHealth.vaccinations.length > 0) {\n          console.log(\n            `Analyse des vaccinations pour ${petHealth.name}:`,\n            petHealth.vaccinations\n          );\n\n          for (const vaccination of petHealth.vaccinations) {\n            console.log(`Vaccination ${vaccination.name}:`, {\n              nextDueDate: vaccination.nextDueDate,\n              status: vaccination.status,\n              date: vaccination.date,\n            });\n\n            // Inclure tous les vaccins qui ont une date d'échéance ou qui ne sont pas à jour\n            if (\n              vaccination.nextDueDate ||\n              vaccination.status !== \"up-to-date\"\n            ) {\n              let daysUntil = 0;\n              let dateToUse = vaccination.nextDueDate;\n              let isOverdue = false;\n\n              if (vaccination.nextDueDate) {\n                const dueDate = new Date(vaccination.nextDueDate);\n                const now = new Date();\n                // Réinitialiser l'heure pour comparer seulement les dates\n                dueDate.setHours(0, 0, 0, 0);\n                now.setHours(0, 0, 0, 0);\n\n                const diffTime = dueDate.getTime() - now.getTime();\n                daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n\n                console.log(\n                  `Calcul pour ${vaccination.name}: ${daysUntil} jours`\n                );\n              } else if (vaccination.status !== \"up-to-date\") {\n                // Si pas de nextDueDate mais status pas à jour, considérer comme en retard\n                daysUntil = -999; // Très en retard\n                dateToUse = vaccination.date; // Utiliser la date du dernier vaccin\n                isOverdue = true;\n              }\n\n              // Inclure les rappels dans les 90 prochains jours ou en retard\n              if (daysUntil <= 90 || isOverdue) {\n                let urgencyLevel: \"critical\" | \"warning\" | \"info\" = \"info\";\n\n                if (daysUntil <= 0 || isOverdue) {\n                  urgencyLevel = \"critical\";\n                } else if (daysUntil <= 7) {\n                  urgencyLevel = \"warning\";\n                } else if (daysUntil <= 30) {\n                  urgencyLevel = \"info\";\n                }\n\n                const reminder = {\n                  id: `vacc-${vaccination.id}`,\n                  type: \"vaccination\" as const,\n                  title: `Vaccin ${vaccination.name}`,\n                  petName: petHealth.name || \"Animal\",\n                  date: dateToUse || vaccination.date,\n                  daysUntil,\n                  urgencyLevel,\n                };\n\n                console.log(`Ajout du rappel:`, reminder);\n                reminders.push(reminder);\n              }\n            }\n          }\n        }\n\n        // Vérifier les rendez-vous médicaux\n        if (petHealth.appointments) {\n          for (const appointment of petHealth.appointments) {\n            const appointmentDate = new Date(\n              `${appointment.date} ${appointment.time || \"00:00\"}`\n            );\n            const now = new Date();\n            const diffTime = appointmentDate.getTime() - now.getTime();\n            const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n\n            // Seulement les rendez-vous dans les 7 prochains jours\n            if (daysUntil >= 0 && daysUntil <= 7) {\n              let urgencyLevel: \"critical\" | \"warning\" | \"info\" = \"info\";\n              if (daysUntil <= 1) urgencyLevel = \"critical\";\n              else if (daysUntil <= 3) urgencyLevel = \"warning\";\n\n              reminders.push({\n                id: `appt-${appointment.id}`,\n                type: \"appointment\",\n                title: appointment.type || \"Rendez-vous\",\n                petName: petHealth.name || \"Animal\",\n                date: appointment.date,\n                daysUntil,\n                urgencyLevel,\n              });\n            }\n          }\n        }\n      } catch (petError) {\n        console.error(`Erreur pour l'animal ${pet.petId}:`, petError);\n        // Continuer avec les autres animaux\n      }\n    }\n\n    // Trier par urgence puis par date\n    const sortedReminders = reminders.sort(\n      (a: UrgentReminder, b: UrgentReminder) => {\n        // D'abord par niveau d'urgence\n        const urgencyOrder: Record<string, number> = {\n          critical: 0,\n          warning: 1,\n          info: 2,\n        };\n        const urgencyDiff =\n          urgencyOrder[a.urgencyLevel] - urgencyOrder[b.urgencyLevel];\n        if (urgencyDiff !== 0) return urgencyDiff;\n\n        // Puis par nombre de jours\n        return a.daysUntil - b.daysUntil;\n      }\n    );\n\n    // Ne pas limiter ici, laisser la Sidebar gérer l'affichage\n    // Mais garder un maximum raisonnable pour éviter la surcharge\n    const topReminders = sortedReminders.slice(0, 20);\n\n    return NextResponse.json({ reminders: topReminders });\n  } catch (error) {\n    console.error(\"Erreur lors de la récupération des rappels urgents:\", error);\n    return NextResponse.json(\n      { error: \"Erreur lors de la récupération des rappels\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}