{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/services/healthService.ts"],"sourcesContent":["import { promises as fs } from \"fs\";\nimport path from \"path\";\nimport type {\n  PetHealth,\n  HealthRecord,\n  MedicalAppointment,\n  Vaccination,\n  VitalStats,\n} from \"../types/health\";\n\nconst DB_PATH = path.join(process.cwd(), \"data\", \"health.json\");\n\nclass HTTPError extends Error {\n  status: number;\n  constructor(message: string, status = 500) {\n    super(message);\n    this.status = status;\n    this.name = \"HTTPError\";\n  }\n}\n\nasync function ensureDB() {\n  try {\n    await fs.access(DB_PATH);\n  } catch (e) {\n    const init = { pets: [] };\n    await fs.mkdir(path.dirname(DB_PATH), { recursive: true });\n    await fs.writeFile(DB_PATH, JSON.stringify(init, null, 2), \"utf8\");\n  }\n}\n\nasync function readDB(): Promise<{ pets: PetHealth[] }> {\n  await ensureDB();\n  const raw = await fs.readFile(DB_PATH, \"utf8\");\n  try {\n    const parsed = JSON.parse(raw);\n    parsed.pets = parsed.pets || [];\n    return parsed;\n  } catch (e) {\n    // If DB is corrupted, reinitialize\n    const init = { pets: [] };\n    await writeDB(init);\n    return init;\n  }\n}\n\nasync function writeDB(db: any) {\n  await fs.writeFile(DB_PATH, JSON.stringify(db, null, 2), \"utf8\");\n}\n\nfunction makeId() {\n  return (global as any).crypto?.randomUUID?.() ?? Date.now().toString();\n}\n\nfunction requirePetId(petId?: string) {\n  if (!petId) throw new HTTPError(\"Missing petId\", 400);\n}\n\nfunction sanitizeString(input?: any) {\n  if (input === undefined || input === null) return \"\";\n  return String(input).trim();\n}\n\nexport async function listPets(): Promise<\n  Array<{ petId: string; name?: string; species?: string }>\n> {\n  const db = await readDB();\n  return (db.pets || []).map((p: any) => ({\n    petId: p.petId,\n    name: p.name,\n    species: p.species,\n  }));\n}\n\n/**\n * Keep createPet for compatibility but note that pet creation should be centralized.\n */\nexport async function createPet(\n  name: string,\n  species?: string,\n  customPetId?: string\n): Promise<PetHealth> {\n  const n = sanitizeString(name);\n  if (!n) throw new HTTPError(\"Missing name\", 400);\n  const db = await readDB();\n  const petId = customPetId || makeId();\n  const newPet: PetHealth = {\n    petId,\n    name: n,\n    species: sanitizeString(species) || \"unknown\",\n    vitalStats: {},\n    vaccinations: [],\n    appointments: [],\n    healthRecords: [],\n  };\n  db.pets = db.pets || [];\n  db.pets.push(newPet);\n  await writeDB(db);\n  return newPet;\n}\n\nexport async function getPetById(petId?: string): Promise<PetHealth> {\n  requirePetId(petId);\n  const db = await readDB();\n  const pet = (db.pets || []).find((p: any) => p.petId === petId);\n  if (!pet) throw new HTTPError(\"Pet not found\", 404);\n  return pet as PetHealth;\n}\n\nexport async function addRecord(\n  petId: string,\n  payload: Partial<HealthRecord>\n): Promise<HealthRecord> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const record: HealthRecord = {\n    id: makeId(),\n    date:\n      sanitizeString(payload.date) || new Date().toISOString().split(\"T\")[0],\n    type: sanitizeString(payload.type) || \"note\",\n    practitioner: sanitizeString(payload.practitioner),\n    notes: sanitizeString(payload.notes),\n  };\n  db.pets[idx].healthRecords = db.pets[idx].healthRecords || [];\n  db.pets[idx].healthRecords.unshift(record);\n  await writeDB(db);\n  return record;\n}\n\nexport async function addAppointment(\n  petId: string,\n  payload: Partial<MedicalAppointment>\n): Promise<MedicalAppointment> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const appointment: MedicalAppointment = {\n    id: makeId(),\n    date: sanitizeString(payload.date),\n    time: sanitizeString(payload.time),\n    type: sanitizeString(payload.type) || \"consultation\",\n    practitioner: sanitizeString(payload.practitioner),\n    notes: sanitizeString(payload.notes),\n  };\n  db.pets[idx].appointments = db.pets[idx].appointments || [];\n  db.pets[idx].appointments.unshift(appointment);\n  await writeDB(db);\n  return appointment;\n}\n\nexport async function addVaccination(\n  petId: string,\n  payload: Partial<Vaccination>\n): Promise<Vaccination> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const vaccination: Vaccination = {\n    id: makeId(),\n    name: sanitizeString(payload.name),\n    date: sanitizeString(payload.date),\n    nextDueDate: sanitizeString(payload.nextDueDate) || undefined,\n    status: (payload?.status as any) || \"up-to-date\",\n  };\n  db.pets[idx].vaccinations = db.pets[idx].vaccinations || [];\n  db.pets[idx].vaccinations.unshift(vaccination);\n  await writeDB(db);\n  return vaccination;\n}\n\nexport async function deleteRecord(\n  petId: string,\n  recordId: string\n): Promise<HealthRecord> {\n  requirePetId(petId);\n  if (!recordId) throw new HTTPError(\"Missing recordId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].healthRecords = db.pets[idx].healthRecords || [];\n  const recIdx = db.pets[idx].healthRecords.findIndex(\n    (r: any) => r.id === recordId\n  );\n  if (recIdx === -1) throw new HTTPError(\"Record not found\", 404);\n  const [deleted] = db.pets[idx].healthRecords.splice(recIdx, 1);\n  await writeDB(db);\n  return deleted as HealthRecord;\n}\n\nexport async function deleteAppointment(\n  petId: string,\n  appointmentId: string\n): Promise<MedicalAppointment> {\n  requirePetId(petId);\n  if (!appointmentId) throw new HTTPError(\"Missing appointmentId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].appointments = db.pets[idx].appointments || [];\n  const aIdx = db.pets[idx].appointments.findIndex(\n    (a: any) => a.id === appointmentId\n  );\n  if (aIdx === -1) throw new HTTPError(\"Appointment not found\", 404);\n  const [deleted] = db.pets[idx].appointments.splice(aIdx, 1);\n  await writeDB(db);\n  return deleted as MedicalAppointment;\n}\n\nexport async function deleteVaccination(\n  petId: string,\n  vaccinationId: string\n): Promise<Vaccination> {\n  requirePetId(petId);\n  if (!vaccinationId) throw new HTTPError(\"Missing vaccinationId\", 400);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  db.pets[idx].vaccinations = db.pets[idx].vaccinations || [];\n  const vIdx = db.pets[idx].vaccinations.findIndex(\n    (v: any) => v.id === vaccinationId\n  );\n  if (vIdx === -1) throw new HTTPError(\"Vaccination not found\", 404);\n  const [deleted] = db.pets[idx].vaccinations.splice(vIdx, 1);\n  await writeDB(db);\n  return deleted as Vaccination;\n}\n\nexport async function updateVital(\n  petId: string,\n  payload: Partial<VitalStats>\n): Promise<VitalStats> {\n  requirePetId(petId);\n  const db = await readDB();\n  const idx = (db.pets || []).findIndex((p: any) => p.petId === petId);\n  if (idx === -1) throw new HTTPError(\"Pet not found\", 404);\n  const existing = db.pets[idx].vitalStats || {};\n  const updated: VitalStats = Object.assign({}, existing, payload || {});\n  db.pets[idx].vitalStats = updated;\n  await writeDB(db);\n  return updated;\n}\n\nexport { HTTPError };\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 284, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/models/Pet.ts"],"sourcesContent":["import mongoose, { Schema, Document } from \"mongoose\";\n\nexport interface IPet extends Document {\n  owner: mongoose.Types.ObjectId;\n  name: string;\n  type: string;\n  breed: string;\n  age?: string;\n  gender: string;\n  weight: string;\n  image: string;\n  microchip?: string;\n  birthdate?: string;\n  status?: string;\n}\n\nconst PetSchema = new Schema<IPet>(\n  {\n    owner: { type: Schema.Types.ObjectId, ref: \"User\", required: true },\n    name: { type: String, required: true },\n    type: { type: String, required: true },\n    breed: { type: String, required: true },\n    age: { type: String, required: true },\n    gender: { type: String, required: true },\n    weight: { type: String },\n    image: { type: String },\n    microchip: { type: String },\n    birthdate: { type: String },\n    status: { type: String, default: \"Actif\" },\n  },\n  { timestamps: true }\n);\n\nconst Pet = mongoose.models.Pet || mongoose.model<IPet>(\"Pet\", PetSchema);\nexport default Pet;\n"],"names":[],"mappings":";;;;AAAA;;AAgBA,MAAM,YAAY,IAAI,mHAAM,CAC1B;IACE,OAAO;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IAClE,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;IACtC,KAAK;QAAE,MAAM;QAAQ,UAAU;IAAK;IACpC,QAAQ;QAAE,MAAM;QAAQ,UAAU;IAAK;IACvC,QAAQ;QAAE,MAAM;IAAO;IACvB,OAAO;QAAE,MAAM;IAAO;IACtB,WAAW;QAAE,MAAM;IAAO;IAC1B,WAAW;QAAE,MAAM;IAAO;IAC1B,QAAQ;QAAE,MAAM;QAAQ,SAAS;IAAQ;AAC3C,GACA;IAAE,YAAY;AAAK;AAGrB,MAAM,MAAM,oHAAQ,CAAC,MAAM,CAAC,GAAG,IAAI,oHAAQ,CAAC,KAAK,CAAO,OAAO;uCAChD","debugId":null}},
    {"offset": {"line": 341, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/lib/db.ts"],"sourcesContent":["import mongoose from \"mongoose\";\n\nconst MONGODB_URI =\n  process.env.MONGODB_URI || \"mongodb://localhost:27017/petconnect\";\n\nif (!MONGODB_URI) {\n  throw new Error(\n    \"Please define the MONGODB_URI environment variable inside .env.local\"\n  );\n}\n\nlet cached = (global as any).mongoose;\n\nif (!cached) {\n  cached = (global as any).mongoose = { conn: null, promise: null };\n}\n\nasync function connectDB() {\n  if (cached.conn) {\n    return cached.conn;\n  }\n  if (!cached.promise) {\n    const opts = {\n      bufferCommands: false,\n    };\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {\n      console.log(\"Connexion à la base de données réussie\");\n      return mongoose;\n    });\n  }\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n\nexport default connectDB;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,QAAQ,GAAG,CAAC,WAAW,IAAI;AAE7B;;AAMA,IAAI,SAAS,yDAAgB,QAAQ;AAErC,IAAI,CAAC,QAAQ;IACX,SAAS,yDAAgB,QAAQ,GAAG;QAAE,MAAM;QAAM,SAAS;IAAK;AAClE;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE;QACf,OAAO,OAAO,IAAI;IACpB;IACA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,OAAO;YACX,gBAAgB;QAClB;QACA,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;YACzD,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT;IACF;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB;uCAEe","debugId":null}},
    {"offset": {"line": 378, "column": 0}, "map": {"version":3,"sources":["file:///Users/med_yassine_khlaf/Documents/GitHub/PetConnect_PWA/app/api/health/%5BpetId%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport {\n  getPetById,\n  createPet,\n  addRecord,\n  addAppointment,\n  addVaccination,\n  deleteRecord,\n  deleteAppointment,\n  deleteVaccination,\n  updateVital,\n  HTTPError,\n} from \"../../../../services/healthService\";\nimport Pet from \"../../../../models/Pet\";\nimport connectDB from \"@/lib/db\";\n// Fonction pour créer une entrée Health à partir des données MongoDB\nasync function createHealthEntryFromMongo(petId: string) {\n  try {\n    await connectDB();\n    const mongoPet = await Pet.findById(petId);\n    if (!mongoPet) {\n      throw new HTTPError(\"Pet not found in MongoDB\", 404);\n    }\n    // Créer l'entrée Health avec les vraies informations de l'animal\n    const healthPet = await createPet(\n      mongoPet.name || `Animal-${petId.slice(0, 8)}`,\n      mongoPet.type || mongoPet.breed || \"Unknown\",\n      petId // Utiliser l'ID MongoDB comme petId\n    );\n    return healthPet;\n  } catch (error: any) {\n    console.error(\"Error creating health entry from MongoDB:\", error);\n    throw new HTTPError(\"Failed to create health entry\", 500);\n  }\n}\n\nexport async function GET(request: NextRequest, { params }: { params: any }) {\n  try {\n    // `params` may be a promise in Next.js route handlers; await it before accessing properties\n    const petId = (await params)?.petId;\n    if (!petId)\n      return NextResponse.json({ error: \"Missing petId\" }, { status: 400 });\n\n    try {\n      const pet = await getPetById(petId);\n      return NextResponse.json(pet);\n    } catch (err: any) {\n      // Si l'animal n'existe pas dans la base Health, le créer automatiquement depuis MongoDB\n      if (err.message === \"Pet not found\") {\n        console.log(`Creating health entry for pet: ${petId}`);\n        const newPet = await createHealthEntryFromMongo(petId);\n        return NextResponse.json(newPet);\n      }\n      throw err;\n    }\n  } catch (err: any) {\n    console.error(\"GET /api/health/[petId] error\", err);\n    if (err instanceof HTTPError)\n      return NextResponse.json({ error: err.message }, { status: err.status });\n    return NextResponse.json({ error: \"Failed to fetch pet\" }, { status: 500 });\n  }\n}\n\n// Fonction helper pour s'assurer que l'animal existe dans la base Health\nasync function ensurePetExists(petId: string) {\n  try {\n    return await getPetById(petId);\n  } catch (err: any) {\n    if (err.message === \"Pet not found\") {\n      console.log(`Auto-creating health entry for pet: ${petId}`);\n      return await createHealthEntryFromMongo(petId);\n    }\n    throw err;\n  }\n}\nexport async function POST(request: NextRequest, { params }: { params: any }) {\n  try {\n    const petId = (await params)?.petId;\n    if (!petId)\n      return NextResponse.json({ error: \"Missing petId\" }, { status: 400 });\n    // S'assurer que l'animal existe dans la base Health avant toute opération\n    await ensurePetExists(petId);\n    const body = await request.json();\n    const { action, payload } = body || {};\n    if (!action || payload === undefined)\n      return NextResponse.json(\n        { error: \"Missing action or payload\" },\n        { status: 400 }\n      );\n\n    if (action === \"addRecord\") {\n      const rec = await addRecord(petId, payload);\n      return NextResponse.json(rec, { status: 201 });\n    }\n\n    if (action === \"addAppointment\") {\n      const appt = await addAppointment(petId, payload);\n      return NextResponse.json(appt, { status: 201 });\n    }\n\n    if (action === \"addVaccination\") {\n      const vac = await addVaccination(petId, payload);\n      return NextResponse.json(vac, { status: 201 });\n    }\n\n    if (action === \"deleteRecord\") {\n      const deleted = await deleteRecord(\n        petId,\n        payload?.id || payload?.recordId\n      );\n      return NextResponse.json(deleted, { status: 200 });\n    }\n\n    if (action === \"deleteAppointment\") {\n      const deleted = await deleteAppointment(\n        petId,\n        payload?.id || payload?.appointmentId\n      );\n      return NextResponse.json(deleted, { status: 200 });\n    }\n\n    if (action === \"deleteVaccination\") {\n      const deleted = await deleteVaccination(\n        petId,\n        payload?.id || payload?.vaccinationId\n      );\n      return NextResponse.json(deleted, { status: 200 });\n    }\n\n    if (action === \"updateVital\") {\n      const vit = await updateVital(petId, payload);\n      return NextResponse.json(vit, { status: 200 });\n    }\n\n    return NextResponse.json({ error: \"Unknown action\" }, { status: 400 });\n  } catch (err: any) {\n    console.error(\"POST /api/health/[petId] error\", err);\n    if (err instanceof HTTPError)\n      return NextResponse.json({ error: err.message }, { status: err.status });\n    return NextResponse.json(\n      { error: \"Failed to update pet\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}